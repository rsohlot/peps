
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <title>PEP 689 – Unstable C API tier | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png"/>
    <link rel="canonical" href="https://peps.python.org/pep-0689.html" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/mq.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg-light" />
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark" />
    <link rel="alternate" type="application/rss+xml" title="Latest PEPs" href="https://www.python.org/dev/peps/peps.rss">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <meta name="description" content="Python Enhancement Proposals (PEPs)"/>
</head>
<body>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-sun-half" viewBox="0 0 24 24" pointer-events="all">
    <title>Following system colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"></circle>
      <path d="M12 3v18m0-12l4.65-4.65M12 14.3l7.37-7.37M12 19.6l8.85-8.85"></path>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected dark colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24" pointer-events="all">
    <title>Selected light colour scheme</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
</svg>
    <script>

        document.documentElement.dataset.colour_scheme = localStorage.getItem("colour_scheme") || "auto"
    </script>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 689</li>
            </ul>
            <button id="colour-scheme-cycler" onClick="setColourScheme(nextColourScheme())">
                <svg class="colour-scheme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
                <svg class="colour-scheme-icon-when-dark"><use href="#svg-moon"></use></svg>
                <svg class="colour-scheme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 689 – Unstable C API tier</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd">Petr Viktorin &lt;encukou&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even">Draft</dd>
<dt class="field-odd">Type<span class="colon">:</span></dt>
<dd class="field-odd">Standards Track</dd>
<dt class="field-even">Requires<span class="colon">:</span></dt>
<dd class="field-even"><a class="reference external" href="../pep-0523">523</a></dd>
<dt class="field-odd">Created<span class="colon">:</span></dt>
<dd class="field-odd">22-Apr-2022</dd>
<dt class="field-even">Python-Version<span class="colon">:</span></dt>
<dd class="field-even">3.11</dd>
<dt class="field-odd">Post-History<span class="colon">:</span></dt>
<dd class="field-odd"><a class="reference external" href="https://mail.python.org/archives/list/python-dev&#64;python.org/thread/PQXSP7E2B6KNXTJ2AERWMKKX42YP5D6O/" title="Python-Dev thread">27-Apr-2022</a></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Table of Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation-rationale">Motivation &amp; Rationale</a><ul>
<li><a class="reference internal" href="#setting-stability-expectations">Setting Stability Expectations</a></li>
<li><a class="reference internal" href="#reserving-underscores-for-private-api">Reserving underscores for Private API</a></li>
<li><a class="reference internal" href="#warning-about-api-that-is-changed-often">Warning about API that is changed often</a></li>
<li><a class="reference internal" href="#changes-during-the-beta-period">Changes during the Beta period</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#adjustments-during-beta-periods">Adjustments during Beta periods</a></li>
<li><a class="reference internal" href="#initial-unstable-api">Initial unstable API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract" role="doc-backlink">Abstract</a></h2>
<p>Some functions and types of the C-API are designated <em>unstable</em>,
meaning that they will not change in patch (bugfix/security) releases,
but may change between minor releases (e.g. between 3.11 and 3.12) without
deprecation warnings.</p>
</section>
<section id="motivation-rationale">
<h2><a class="toc-backref" href="#motivation-rationale" role="doc-backlink">Motivation &amp; Rationale</a></h2>
<p>The Python C-API is currently divided into <a class="reference external" href="https://devguide.python.org/c-api/">three tiers</a>:</p>
<ul class="simple">
<li>Limited API, with high compatibility expectations</li>
<li>Public API, which follows the <a class="pep reference internal" href="../pep-0387" title="PEP 387 – Backwards Compatibility Policy">backwards compatibility policy</a>, and requires deprecation warnings before changes</li>
<li>Private (internal) API, which can change at any time.</li>
</ul>
<p>Tools requring access to CPython internals (e.g. advanced
debuggers and JIT compilers) are often built for minor series releases
of CPython, and assume that the C-API internals used do not change
in patch releases. To support these tools, we need a tier between the
Public and Private C-API, with guarantees on stability throughout
the minor-series release.</p>
<section id="setting-stability-expectations">
<h3><a class="toc-backref" href="#setting-stability-expectations" role="doc-backlink">Setting Stability Expectations</a></h3>
<p>Currently, there are no guarantees for the internal API – that is, anything
that requires <code class="docutils literal notranslate"><span class="pre">Py_BUILD_CORE</span></code> or is named with a leading underscore.
This API can change without warning at any time, and code that uses it
is pinned to a specific build of Python.</p>
<p>However, in practice, even the internal API usually happens to be stable
in patch releases:</p>
<ul class="simple">
<li>Some CPython core developers take this as an an unwritten rule.</li>
<li>Patch releases only contain bugfixes, which are unlikely to
change the API.</li>
</ul>
<p>Unstable API will make the stability expectations more explicit.</p>
<p>It will also hopefully encourage existing users of the private API to
reach out to python-dev, so we can expose, standardize and test an API
for some of their use cases.</p>
</section>
<section id="reserving-underscores-for-private-api">
<h3><a class="toc-backref" href="#reserving-underscores-for-private-api" role="doc-backlink">Reserving underscores for Private API</a></h3>
<p><a class="pep reference internal" href="../pep-0523" title="PEP 523 – Adding a frame evaluation API to CPython">PEP 523</a> introduced functions for use by debuggers and JIT compilers,
which are stable only across minor releases.
The functions names have leading underscores to suggest their limited
stability.</p>
<p>However, leading underscores usually mark <em>fully private</em> API.
CPython developers familiar with the “underscore means internal”
convention are unlikely to check if underscored functions they are
changing are documented and used outside CPython itself.</p>
<p>This proposal brings us a bit closer to reserving underscores
only for truly internal, private, hands-off API.</p>
</section>
<section id="warning-about-api-that-is-changed-often">
<h3><a class="toc-backref" href="#warning-about-api-that-is-changed-often" role="doc-backlink">Warning about API that is changed often</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">PyCode_New()</span></code> family is an example of functions that are
documented as unstable (“Calling [it] directly can bind you to a precise
Python version”), and also often change in practice.</p>
<p>Moving it to the unstable tier will make its status obvious even
to people who don’t read the docs carefully enough, and will make it
hard to use accidentally.</p>
</section>
<section id="changes-during-the-beta-period">
<h3><a class="toc-backref" href="#changes-during-the-beta-period" role="doc-backlink">Changes during the Beta period</a></h3>
<p>Since the API itself can change continuously up until Beta 1 (feature freeze)
of a minor version, major users of this API are unlikely to test
Alpha releases and provide feedback.
It is very difficult to determine what needs to be exposed as unstable.</p>
<p>Additions to the unstable tier will count as <em>stabilization</em>,
and will be allowed up to Release Candidate 1.</p>
</section>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification" role="doc-backlink">Specification</a></h2>
<p>Several functions and types (“APIs”) will be moved to a new <em>unstable</em> tier.</p>
<p>They will be expected to stay stable across patch releases,
but may change or be removed without warning in minor releases (3.x.0),
including Alpha and Beta releases of 3.x.0.</p>
<p>When they change significantly, code that uses them should no longer compile
(e.g. arguments should be added/removed, or a function should be renamed,
but the semantic meaning of an argument should not change).</p>
<p>Their definitions will be moved to a new directory, <code class="docutils literal notranslate"><span class="pre">Include/unstable/</span></code>,
and will be included from <code class="docutils literal notranslate"><span class="pre">Python.h</span></code>.</p>
<p>From Python 3.12 on, these APIs will only be usable when the
<code class="docutils literal notranslate"><span class="pre">Py_USING_UNSTABLE_API</span></code> macro is defined.
CPython will only define the macro for building CPython itself
(<code class="docutils literal notranslate"><span class="pre">Py_BUILD_CORE</span></code>).</p>
<p>To make transition to unstable API easier,
in Python 3.11 the APIs will be available without <code class="docutils literal notranslate"><span class="pre">Py_USING_UNSTABLE_API</span></code>
defined. In this case, using them will generate a deprecation warning on
compilers that support <code class="docutils literal notranslate"><span class="pre">Py_DEPRECATED</span></code>.</p>
<p>A similar deprecation period will be used when making more APIs unstable
in the future:</p>
<ul class="simple">
<li>When moving from public API, the deprecation period should follow Python’s
backwards compatibility policy (currently, it should last at least
two releases).</li>
<li>When moving from public API that is documented as unstable,
the deprecation period can only last one release.</li>
<li>When moving from private API or adding new API, no deprecation period
is necessary.</li>
</ul>
<p>Leading underscores will be removed from the names of the moved APIs.
The old underscored name of a renamed API will be available (as an alias
using <code class="docutils literal notranslate"><span class="pre">#define</span></code>) at least until that API changes.</p>
<p>The unstable C-API tier and <code class="docutils literal notranslate"><span class="pre">Py_USING_UNSTABLE_API</span></code> will be documented,
and documentation of each unstable API will be updated.</p>
<section id="adjustments-during-beta-periods">
<h3><a class="toc-backref" href="#adjustments-during-beta-periods" role="doc-backlink">Adjustments during Beta periods</a></h3>
<p>New APIs can be added to the unstable tier, and private APIs can be moved
to it, up to the first release candidate of a new minor version.
Consensus on the <code class="docutils literal notranslate"><span class="pre">capi-sig</span></code> or <code class="docutils literal notranslate"><span class="pre">python-dev</span></code> is needed in the Beta period.</p>
<p>In the Beta period, no API may be moved to more private tier, e.g.
what is public in Beta 1 must stay public until the final release.</p>
</section>
<section id="initial-unstable-api">
<h3><a class="toc-backref" href="#initial-unstable-api" role="doc-backlink">Initial unstable API</a></h3>
<p>The following API will initially be unstable.
The set may be adjusted for 3.11.</p>
<p>Code object constructors:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">PyCode_New()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyCode_NewWithPosOnlyArgs()</span></code></li>
</ul>
<p>Frame evaluation API (PEP 523):</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">_PyFrameEvalFunction</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">_PyInterpreterState_GetEvalFrameFunc()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">_PyInterpreterState_SetEvalFrameFunc()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">_PyEval_RequestCodeExtraIndex()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">_PyCode_GetExtra()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">_PyCode_SetExtra()</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">_PyInterpreterFrame</span></code> (as an incomplete, opaque struct)</li>
<li><code class="docutils literal notranslate"><span class="pre">_PyFrame_GetFrameObject</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">PyEval_EvalFrameDefault</span></code>
(new function that calls <code class="docutils literal notranslate"><span class="pre">_PyEval_EvalFrameDefault</span></code>, but takes
<code class="docutils literal notranslate"><span class="pre">PyFrameObject</span></code> rather than <code class="docutils literal notranslate"><span class="pre">_PyInterpreterFrame</span></code>)</li>
</ul>
<p>(Leading underscores will be removed as mentioned above.)</p>
</section>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility" role="doc-backlink">Backwards Compatibility</a></h2>
<p>The C API backwards compatibility story will be made clearer.</p>
</section>
<section id="how-to-teach-this">
<h2><a class="toc-backref" href="#how-to-teach-this" role="doc-backlink">How to Teach This</a></h2>
<p>The changes affect advanced C programmers, who should consult the
updated reference documentation, devguide and/or What’s New document·.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation" role="doc-backlink">Reference Implementation</a></h2>
<p><a class="reference external" href="https://github.com/python/cpython/issues/91744">https://github.com/python/cpython/issues/91744</a></p>
</section>
<section id="rejected-ideas">
<h2><a class="toc-backref" href="#rejected-ideas" role="doc-backlink">Rejected Ideas</a></h2>
<p>It might be good to add a similar tier in the Python (not C) API,
e.g. for <code class="docutils literal notranslate"><span class="pre">types.CodeType</span></code>.
However, the opt-in mechanism would need to be different (if any).
This is outside the scope of the PEP.</p>
</section>
<section id="open-issues">
<h2><a class="toc-backref" href="#open-issues" role="doc-backlink">Open Issues</a></h2>
<p>The exact set of exposed API may change.</p>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright" role="doc-backlink">Copyright</a></h2>
<p>This document is placed in the public domain or under the
CC0-1.0-Universal license, whichever is more permissive.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/pep-0689.rst">https://github.com/python/peps/blob/main/pep-0689.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/pep-0689.rst">2022-05-04 08:02:41 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#motivation-rationale">Motivation &amp; Rationale</a><ul>
<li><a class="reference internal" href="#setting-stability-expectations">Setting Stability Expectations</a></li>
<li><a class="reference internal" href="#reserving-underscores-for-private-api">Reserving underscores for Private API</a></li>
<li><a class="reference internal" href="#warning-about-api-that-is-changed-often">Warning about API that is changed often</a></li>
<li><a class="reference internal" href="#changes-during-the-beta-period">Changes during the Beta period</a></li>
</ul>
</li>
<li><a class="reference internal" href="#specification">Specification</a><ul>
<li><a class="reference internal" href="#adjustments-during-beta-periods">Adjustments during Beta periods</a></li>
<li><a class="reference internal" href="#initial-unstable-api">Initial unstable API</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#how-to-teach-this">How to Teach This</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#rejected-ideas">Rejected Ideas</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br />
            <a id="source" href="https://github.com/python/peps/blob/main/pep-0689.rst">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
</body>
</html>